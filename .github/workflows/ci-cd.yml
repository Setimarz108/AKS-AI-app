name: RetailBot Simple CI/CD

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure CLI
        run: |
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --password ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
      
      - name: Build and Push Images
        run: |
          # Login to ACR
          az acr login --name ${{ secrets.ACR_NAME }}
          
          # Build and push frontend
          az acr build --registry ${{ secrets.ACR_NAME }} \
            --image retailbot-frontend:latest \
            app/frontend
          
          # Build and push backend  
          az acr build --registry ${{ secrets.ACR_NAME }} \
            --image retailbot-api:latest \
            app
      
      - name: Restart Containers
        run: |
          az container restart \
            --resource-group rg-retailbot-demo \
            --name ci-retailbot-app-demo
      
      - name: Wait and Test
        run: |
          echo "Waiting for restart..."
          sleep 90
          
          # Simple health check
          curl -f http://retailbot-app-78n7.westeurope.azurecontainer.io:8000/health || echo "Health check failed"