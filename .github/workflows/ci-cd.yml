name: RetailBot CI/CD

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate image tag
        id: tag
        run: echo "image_tag=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: Login to Azure Container Registry
        run: az acr login --name ${{ env.ACR_NAME }}
      
      - name: Build and push backend image
        run: |
          cd app
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/retailbot-api:${{ steps.tag.outputs.image_tag }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/retailbot-api:${{ steps.tag.outputs.image_tag }} ${{ env.ACR_NAME }}.azurecr.io/retailbot-api:latest
          docker push ${{ env.ACR_NAME }}.azurecr.io/retailbot-api:${{ steps.tag.outputs.image_tag }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/retailbot-api:latest
      
      - name: Build and push frontend image
        run: |
          cd app/frontend
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/retailbot-frontend:${{ steps.tag.outputs.image_tag }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/retailbot-frontend:${{ steps.tag.outputs.image_tag }} ${{ env.ACR_NAME }}.azurecr.io/retailbot-frontend:latest
          docker push ${{ env.ACR_NAME }}.azurecr.io/retailbot-frontend:${{ steps.tag.outputs.image_tag }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/retailbot-frontend:latest
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
      
      - name: Terraform Init
        run: |
          cd terraform
          export ARM_ACCESS_KEY="${{ secrets.AZURE_STORAGE_KEY }}"
          terraform init
      
      - name: Deploy with Terraform
        run: |
          cd terraform
          export ARM_ACCESS_KEY="${{ secrets.AZURE_STORAGE_KEY }}"
          terraform apply -auto-approve \
            -target=module.container_instances.azurerm_container_group.app \
            -var="frontend_image_tag=${{ steps.tag.outputs.image_tag }}" \
            -var="backend_image_tag=${{ steps.tag.outputs.image_tag }}"
      
      - name: Verify deployment
        run: |
          echo "Waiting for containers to start..."
          sleep 45
          cd terraform
          export ARM_ACCESS_KEY="${{ secrets.AZURE_STORAGE_KEY }}"
          FRONTEND_URL=$(terraform output -raw frontend_url)
          echo "Testing frontend: $FRONTEND_URL"
          curl -f "$FRONTEND_URL" || echo "Frontend check failed but continuing..."
          echo "Testing backend health: $FRONTEND_URL:8000/health"
          curl -f "$FRONTEND_URL:8000/health" || echo "Backend check failed but continuing..."
          echo "Deployment completed"

  rollback:
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    needs: [build-and-deploy]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
      
      - name: Terraform Init
        run: |
          cd terraform
          export ARM_ACCESS_KEY="${{ secrets.AZURE_STORAGE_KEY }}"
          terraform init
      
      - name: Rollback to latest stable
        run: |
          cd terraform
          export ARM_ACCESS_KEY="${{ secrets.AZURE_STORAGE_KEY }}"
          echo "Rolling back to latest stable version"
          terraform apply -auto-approve \
            -target=module.container_instances.azurerm_container_group.app \
            -var="frontend_image_tag=latest" \
            -var="backend_image_tag=latest"